===================
Bootstraping on CLI
===================

Compysition comes with a CLI tool to easily bootstrap a server using a YAML
formatted config file.  Following file creates exactly the same environment as
the above example:

.. literalinclude:: examples/test_setup.yaml
   :language: yaml

Bootstrapping the environment is just a matter of invoking the **compysition**
executable with the --config parameter pointing to the bootstrap file.


Available commands
==================

start
-----

The start command detaches the Compysition server from console and runs it in the
background.  This implies that logs are written to syslog unless specifically
defined otherwise.  Metrics are written to Null unless specifically defined
otherwise.

The pidfile contains the pids of the control process and all child processes.
When stopping a Compysition instance make sure you point to the pid file used to
start the Compysition instance.


.. code-block:: sh

    [smetj@indigo ~]$ compysition start -h
    usage: compysition start [-h] [--config CONFIG] [--instances INSTANCES]
                          [--pid PID]

    Starts a Compysition instance and detaches to the background. Logs are written to
    syslog.

    optional arguments:
      -h, --help            show this help message and exit
      --config CONFIG       The Compysition bootstrap file to load.
      --instances INSTANCES
                            The number of parallel Compysition instances to
                            bootstrap.
      --pid PID             The pidfile to use.


------------------

debug
-----

The debug command does pretty much the same as start just that it keeps the
Compysition instance in the foreground without detaching it.  Logs are written to
STDOUT.  The running instance can be stopped gracefully with CTRL+C

.. code-block:: sh

    [smetj@indigo ~]$ compysition debug -h
    usage: compysition debug [-h] [--config CONFIG] [--instances INSTANCES]

    Starts a Compysition instance in foreground and writes logs to STDOUT.

    optional arguments:
      -h, --help            show this help message and exit
      --config CONFIG       The Compysition bootstrap file to load.
      --instances INSTANCES
                            The number of parallel Compysition instances to
                            bootstrap.


------------------

stop
----

Stops the Compysition instance gracefully by sending SIGINT to all processes.

.. code-block:: sh

    smetj@indigo ~]$ compysition stop -h
    usage: compysition stop [-h] [--pid PID]

    Tries to gracefully stop the Compysition instance.

    optional arguments:
      -h, --help  show this help message and exit
      --pid PID   The pidfile to use.


------------------

kill
----

** Use with caution, sends SIGKILL to the pids in the pidfile. **

.. code-block:: sh

    [smetj@indigo ~]$ compysition kill -h
    usage: compysition kill [-h] [--pid PID]

    Kills the Compysition processes immediately.

    optional arguments:
      -h, --help  show this help message and exit
      --pid PID   The pidfile to use.


------------------

list
----

Lists all installed Compysition modules, given that they have the correct entry-points.

.. code-block:: sh

    [smetj@indigo ~]$ compysition list
    Available Compysition modules:
    +---------------------------+-------------------+-----------+------------------------------------------------------------------------------------------+
    | Group                     | Module            | Version   | Description                                                                              |
    +---------------------------+-------------------+-----------+------------------------------------------------------------------------------------------+
    | compysition.builtin.logging  | loglevelfilter    | 0.4.0beta | A builtin Compysition module which filters Compysition log events.                             |
    |                           | humanlogformatter | 0.4.0beta | A builtin Compysition module which formats Compysition log events.                             |
    |                           |                   |           |                                                                                          |
    | compysition.builtin.metrics  | graphite          | 0.4.0beta | A builtin Compysition module which formats the internal metric format into Graphite format. |
    |                           |                   |           |                                                                                          |
    | compysition.builtin.flow     | roundrobin        | 0.4.0beta | A builtin Compysition module which round robins incoming events                             |
    |                           |                   |           |     over all connected queues.                                                           |
    |                           | fanout            | 0.4.0beta | A builtin Compysition module which duplicates incoming events to all                        |
    |                           |                   |           |     connected queues.                                                                    |
    |                           | tippingbucket     | 0.4.0beta | A builtin Compysition module which buffers data.                                            |
    |                           | funnel            | 0.4.0beta | A builtin Compysition module which merges incoming events from different                    |
    |                           |                   |           |     queues into 1 queue.                                                                 |
    |                           | lockbuffer        | 0.4.0beta | A builtin Compysition module with a fixed size inbox queue.                                 |
    |                           |                   |           |                                                                                          |
    | compysition.builtin.function | header            | 0.4.0beta |  A builtin Compysition module which adds the defined dictionary                             |
    |                           |                   |           |     to the header of each passing event.                                                 |
    |                           |                   |           |                                                                                          |
    | compysition.builtin.input    | testevent         | 0.4.0beta | A WishBone input module which generates a test event at the chosen interval.             |
    |                           |                   |           |                                                                                          |
    | compysition.builtin.output   | syslog            | 0.4.0beta | Writes Compysition log events to syslog.                                                    |
    |                           | null              | 0.4.0beta | Accepts events and purges these without any further processing.                          |
    |                           | stdout            | 0.4.0beta | A builtin Compysition module prints events to STDOUT.                                       |
    |                           |                   |           |                                                                                          |
    | compysition.input            | dictgenerator     | 0.1       | A WishBone input module which generates dictionaries build out of words randomly         |
    |                           |                   |           |     chosen from a provided wordlist.                                                     |
    |                           | amqp              | 0.1       | A Compysition AMQP input module.                                                            |
    |                           | gearman           | 0.1       | A Compysition input module which consumes jobs from a Gearmand server.                      |
    |                           | generator         | 0.1       | A WishBone IO module which generates random data for testing purposes.                   |
    |                           | namedpipe         | 0.1       | A Compysition IO module which accepts external input from a named pipe.                     |
    |                           | tcp               | 0.1       | A Compysition input module which listens on a TCP socket.                                   |
    |                           | udp               | 0.1       | A Compysition module which handles UDP input.                                               |
    |                           | uds               | 0.1       | A Compysition input module which listens on a unix domain socket.                           |
    |                           | mongodb           | 0.1       | A Compysition output module to write data in MongoDB.                                       |
    |                           |                   |           |                                                                                          |
    | compysition.output           | amqp              | 0.1       | A Compysition AMQP output module.                                                           |
    |                           | tcp               | 0.1       | A Compysition IO module which writes data to a TCP socket.                                  |
    |                           | uds               | 0.1       | A Compysition IO module which writes data to a Unix domain socket.                          |
    |                           |                   |           |                                                                                          |
    | compysition.function         | skeleton          | 0.1       | A bare minimum Compysition function module.                                                 |
    |                           | msgpack           | 0.1       | A Compysition which de/serializes data into or from msgpack format.                         |
    |                           | snappy            | 0.1       | A Compysition module which compresses or decompresses data using Snappy.                    |
    |                           | json              | 0.1       | A Compysition module which converts and validates JSON.                                     |
    |                           | waitseconds       | 0.1       | An output module which takes x seconds to finish the <consume> function.                 |
    |                           |                   |           |                                                                                          |
    +---------------------------+-------------------+-----------+------------------------------------------------------------------------------------------+


------------------

show
----

Displays the docstring of the requested module.


.. code-block:: sh

    [smetj@indigo ~]$ compysition show compysition.builtin.flow.fanout
    **A builtin Compysition module which duplicates incoming events to all
        connected queues.**

        Create a "1 to n" relationship with queues.  Events arriving in inbox
        are then copied to each queue connected to this module.  Keep in mind
        that the outbox queue is never used.

        When clone is True, each incoming event is duplicated for each outgoing
        queue.  This might be usefull if you require to change the content of the
        events later down the pipeline.  Otherwise references are used which means
        changing the event will change it everywhere in the current Compysition
        framework.


        Parameters:

            name(str):      The name of the module.

            clone(bool):    When True actually makes a copy instead of passing
                            a reference.

        Queues:

            inbox:  Incoming events


